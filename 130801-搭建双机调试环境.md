Windows内核学习之搭建双机调试环境
=====

**Author：[cauligflower](http://cauligflower.github.com)**

**Time：2013.08.01**

**Title：通过WinDbg和VMWare搭建双机内核调试环境**

-----

#####1.安装WinDbg，VMWare，WDK（非调试必须）。



#####2.配置虚拟机串口信息。

1).选择"Serial Port"

2).选择"Output to named pipe"

3).选择"The other end is an application" 

4).勾选"Connect at power on"

![](http://y.photo.qq.com/img?s=7kN7KeirY&l=y.jpg)




#####3.1通过boot.ini文件设置虚拟机操作系统启动菜单（XP和2003系统）

设置文件夹选项显示隐藏文件、系统文件，在系统盘所在根目录使用文本编辑器打开boot.ini文件，去掉只读属性，在文件末尾写入以下内容：

```
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS="Microsoft Windows XP Professional Debug" 
/noexecute=optin /fastdetect /debug /debugport=COM1 /baudrate=115200
```

![](http://y.photo.qq.com/img?s=4dRFGzjvn&l=y.jpg)

PS：COM1对应虚拟机设置中的Serial Port，如果虚拟机串口是Serial Port 2，则此处对应COM2。




#####3.2通过bcdedit设置虚拟机操作系统启动菜单（Vista和Win7系统）

1).使用管理员权限运行cmd，输入```bcdedit```命令。

![](http://y.photo.qq.com/img?s=8Cvr6s0mN&l=y.jpg)

2).拷贝当前的启动配置，输入```bcdedit /copy {current} /d "Windows  Debug" ```。

3).记录当前的Debug GUID。

4).增加新加的启动菜单，并增加调试功能，输入```bcdedit /debug {Debug GUID} ON```。

5).修改调试设置，输入```bcdedit /dbgsettings SERIAL DEBUGPORT:1 BAUDRATE:115200```。

PS：这里的SERIAL DEBUGPORT跟XP下的是一样的，Serial Port则为1，Serial Port 2则为2。

![](http://y.photo.qq.com/img?s=Zvefz6s1t&l=y.jpg)




#####4.建立WinDbg桌面快捷方式，查看属性，在目标项后添加如下运行参数。

```
D:\WinDDK\Debuggers\windbg.exe 
-y SRV*D:\WinDDK\symbol_XP*http://msdl.microsoft.com/download/symbols 
-b -k com:pipe,port=\\.\pipe\com_1,baud=115200,pipe
```

1).参数-y表示符号表路径，可以做到一个Windbg快捷方式对应一个虚拟机系统符号表，不需要反复切换设置符号表。

2).D:\WinDDK\symbol_XP是本地的符号表路径，后面则是微软的符号表服务器URL。

补充：如果还是无法调试，可以正常启动虚拟机（非调试模式），在设备管理器中，对COM1串口进行每秒位数项的设置，设置为115200。

![](http://y.photo.qq.com/img?s=veHR7T6ml&l=y.jpg)




#####5.开启WinDbg，运行虚拟机，即可看到符号加载（首次加载符号，速度会很慢），成功与虚拟机连接。

![](http://y.photo.qq.com/img?s=ptwGyoJJm&l=y.jpg)

Win7的启动菜单以及WinDbg联机调试。

![](http://y.photo.qq.com/img?s=EjV1kcDZq&l=y.jpg)

![](http://y.photo.qq.com/img?s=OsW2Dhl7i&l=y.jpg)


-----

WinDbg下载：

http://msdn.microsoft.com/en-us/windows/hardware/gg463009.aspx

VS2010旗舰版下载：

ed2k://|file|cn_visual_studio_2010_ultimate_x86_dvd_532347.iso|2685982720|4AE6228933DDE49D9BFA4C3467C831C2|/

WDK7600下载：

http://download.microsoft.com/download/4/A/2/4A25C7D5-EFBE-4182-B6A9-AE6850409A78/GRMWDK_EN_7600_1.ISO

VMWare9下载：

ed2k://|file|%5B%28VMware.Workstation.%29v9.0.2%5D.%5B%28VMware.Workstation.%29v9.0.2%5D.%5B%28VMware.Workstation.%29v9.0.2%5D.Vmware.Workstation.v9.0.2.1031769.Incl.Keymaker-Zwt.zip|426456429|f08a6daeb1ee7ce4ddf27f8c133e1b7e|/
