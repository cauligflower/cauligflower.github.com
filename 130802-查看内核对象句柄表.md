Windows内核学习之通过Windbg调试查看内核对象句柄表
=====

**Author：[cauligflower](http://cauligflower.github.com)**

**Time：2013.08.02**

**Title：通过Windbg调试查看内核对象句柄表**

-----

之前学习了Windbg的一些基础命令，但是不练习还是容易忘记，本身想通过Windbg查看下SSDT及其相关内容，但是这里后面需要单独来学习，这里就用句柄表为例熟悉Windbg的使用。

Windows程序中经常使用到内核对象，提到内核对象不得不提句柄这个概念。

进程在初始化时，系统将为它分配一个句柄表（handle table）。此时句柄表为空，当进程内的一个线程调用一个创建内核对象的函数时，内核将为这个对象分配并初始化一个内存块。

用于创建内核对象的任何函数都会返回一个与进程相关的句柄，这个句柄可以供运行的所有线程使用。句柄值实际是作为进程句柄表的索引来使用的，所以这些句柄始于当前这个进程相关的，无法供其他进程使用。凡是用于创建内核对象的函数，在检查他们的返回值时一定要注意NULL（0）和INVALID_HANDLE_VALUE（-1）的区别。

对于使用```BOOL CloseHandle(HANDLE hObject);```关闭的内核对象句柄，需要将数值设置为NULL，避免再次使用时破坏其他EPROCESS结构。

进程是一个容器，拥有资源，拥有代码，可以通过线程运行。进程可以通过句柄表找到相关内核对象，进程内的线程可以操作相关内核对象。

![](http://y.photo.qq.com/img?s=iBW3QVOff&l=y.jpg)

下面就一步步通过WinDbg的调试功能找到所谓的句柄表。

1.首先枚举当前系统进程信息，使用如下命令：```!process 0 0```

2.找到需要查看的notepad.exe，可以发现PROCESS的值为0x86569d40，其中也包含有一些其他信息，例如句柄表地址，句柄数，映像名之类。

![](http://y.photo.qq.com/img?s=34yizVdoS&l=y.jpg)

3.查看进程的EPROCESS结构，这个结构非常大，这里只学习句柄表部分，所以就不截全部的部分了。其中UniqueProcessId标识当前进程ID，在0x0f4偏移处就是HANDLE_TABLE结构指针。

![](http://y.photo.qq.com/img?s=P5JCRAguT&l=y.jpg)

4.查看进程HADLE_TABLE结构，其中最重要的TableCode指向句柄表。

![](http://y.photo.qq.com/img?s=MieHGcLDp&l=y.jpg)

5.查看0x979d6000处的数据。

![](http://y.photo.qq.com/img?s=cuiFBlxx3&l=y.jpg)

十六进制0x979d6000转换为二进制10010111100111010110000000000000，可以看到最后两位为00，代表当前句柄表为1层表，01代表二层表，10代表三层表，Windows现在暂时使用到三层表结构。

![](http://y.photo.qq.com/img?s=tfEg7lXfD&l=y.jpg)

毕竟才开始学习内核，先熟悉一下命令，后面有相关需要了，再进行深入研究吧。

-----

参考资料

Windows句柄表分配算法分析：http://bbs.pediy.com/showthread.php?t=84827

Windows句柄表分配算法分析（实验部分）：http://bbs.pediy.com/showthread.php?t=84837